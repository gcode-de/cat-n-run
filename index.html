<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jump and Hund</title>

    <style>
        canvas {
            background-color: rgba(0, 0, 0, 0.8);
        }
    </style>

    <script>
        let KEY_SPACE = false; // 32
        let KEY_UP = false; // 38
        let KEY_DOWN = false; // 40
        let jumpStart = 0;
        let jumpActive = false;
        let canvas;
        let ctx;
        let backgroundImage = new Image();
        let jumpAudio = new Audio('assets/jump.wav');
        let collisionAudio = new Audio('assets/collision.wav');
        let dogBark = new Audio('assets/bark.wav');


        let cat = {
            x: 200,
            y: 220,
            width: 100,
            height: 70,
            src: 'assets/cat.png'
        };

        let dogs = [];
        let shots = [];

        document.onkeydown = function (e) {
            if (e.keyCode == 32) { // Leertaste gedrückt
                KEY_SPACE = true;
            }

            if (e.keyCode == 38) { // Nach oben gedrückt
                KEY_UP = true;
            }

            if (e.keyCode == 40) { // Nach unten gedrückt
                KEY_DOWN = true;
            }
        }


        document.onkeyup = function (e) {
            if (e.keyCode == 32) { // Leertaste losgelassen
                KEY_SPACE = false;
            }


            if (e.keyCode == 38) { // Nach oben losgelassen
                KEY_UP = false;
            }

            if (e.keyCode == 40) { // Nach unten losgelassen
                KEY_DOWN = false;
            }
        }
        let clickTimer;

        document.onclick = function () {
            if (clickTimer) clearTimeout(clickTimer);
            clickTimer = setTimeout(function () {

                if (jumpActive === true) {
                    return
                }
                jumpStart = new Date().getTime();
                jumpActive = true;
                jumpAudio.play();
                cat.y -= 150;
            }, 250);
        }

        document.ondblclick = function () {
            clearTimeout(clickTimer);
            let shot = {
                x: cat.x + 110,
                y: cat.y + 22,
                width: 60,
                height: 30,
                src: 'assets/bone.png',
                img: new Image()
            };
            shot.img.src = shot.src; // Laser-Bild wird geladen.

            shots.push(shot);
        }



        function startGame() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            loadImages();
            setInterval(update, 1000 / 25);
            setInterval(createUfos, 5000);
            setInterval(checkForCollion, 1000 / 25);
            // setInterval(checkForShoot, 1000 / 10);
            draw();
        }

        function checkForCollion() {
            dogs.forEach(function (dog) {

                // Kontrollieren, ob Hund mit Cat kollidiert
                if (cat.x + cat.width > dog.x &&
                    cat.y + cat.height > dog.y &&
                    cat.x < dog.x &&
                    cat.y < dog.y + dog.height
                ) {
                    collisionAudio.play();
                    console.log('Collision!!!');
                    dogs = dogs.filter(u => u != dog);
                    // clearInterval(update); -> funktioniert nicht
                    // clearInterval(createUfos);
                    // clearInterval(checkForCollion);
                    // clearInterval(checkForShoot);
                }


                shots.forEach(function (shot) {
                    // Kontrollieren, ob Laser mit Hund kollidiert
                    if (shot.x + shot.width > dog.x &&
                        shot.y + shot.height > dog.y &&
                        shot.x < dog.x &&
                        shot.y < dog.y + dog.height
                    ) {
                        dog.hit = true;
                        dogBark.play();
                        console.log('Collision!!!');

                        setTimeout(() => {
                            dogs = dogs.filter(u => u != dog);
                        }, 2000);
                    }

                });

            });
        }

        function createUfos() {
            let dog = {
                x: 720,
                y: 210,
                width: 100,
                height: 80,
                src: 'assets/dog.png',
                img: new Image()
            };
            dog.img.src = dog.src;
            dogs.push(dog);
        }

        // function checkForShoot() {
        //     if (KEY_SPACE) {
        //         let shot = {
        //             x: cat.x + 110,
        //             y: cat.y + 22,
        //             width: 20,
        //             height: 4,
        //             src: 'assets/shot.png',
        //             img: new Image()
        //         };
        //         shot.img.src = shot.src; // Laser-Bild wird geladen.

        //         shots.push(shot);
        //     }
        // }

        function update() {
            if (KEY_UP) {
                cat.y -= 5;
            }

            if (KEY_DOWN) {
                cat.y += 5;
            }

            dogs.forEach(function (dog) {
                if (!dog.hit) {
                    dog.x -= 5;
                }
            });

            shots.forEach(function (shot) {
                shot.x += 15;
            });

            const jumpCurrent = new Date().getTime();
            if ((jumpCurrent - jumpStart) > 1500 && jumpActive === true) {
                cat.y += 150;
                jumpActive = false;
            }

        }

        function loadImages() {
            backgroundImage.src = 'assets/background.jpg';
            cat.img = new Image();
            cat.img.src = cat.src;
        }

        function draw() {
            ctx.drawImage(backgroundImage, 0, 0);
            ctx.drawImage(cat.img, cat.x, cat.y, cat.width, cat.height);

            dogs.forEach(function (dog) {
                ctx.drawImage(dog.img, dog.x, dog.y, dog.width, dog.height);
            });


            shots.forEach(function (shot) {
                ctx.drawImage(shot.img, shot.x, shot.y, shot.width, shot.height);
            });


            requestAnimationFrame(draw);
        }
    </script>
</head>

<body onload="startGame()">
    <canvas id="canvas" width="720" height="300"></canvas>

</body>

</html>